<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piece Hall - Content Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .bg-sandstone-gold { background-color: #B3A369; }
        .text-sandstone-gold { color: #B3A369; }
        .border-sandstone-gold { border-color: #B3A369; }
        .form-input {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e2e8f0;
        }
        .form-input:focus {
            outline: none;
            border-color: #B3A369;
            box-shadow: 0 0 0 2px rgba(179, 163, 105, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
            <img src="https://www.thepiecehall.co.uk/wp-content/uploads/2021/06/ThePieceHall_Logo_white.png" alt="The Piece Hall Logo" class="h-12 w-auto mx-auto mb-6">
            <h1 class="text-3xl text-sandstone-gold text-center mb-6">Content Portal</h1>
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <label for="admin-email" class="block text-sandstone-gold font-semibold mb-2">Email</label>
                    <input type="email" id="admin-email" required class="w-full rounded-lg p-3 form-input" placeholder="your-email@example.com">
                </div>
                <div>
                    <label for="admin-password" class="block text-sandstone-gold font-semibold mb-2">Password</label>
                    <input type="password" id="admin-password" required class="w-full rounded-lg p-3 form-input">
                </div>
                <button type="submit" class="w-full p-4 bg-sandstone-gold text-black font-bold text-lg rounded-lg shadow-lg hover:bg-yellow-500 transition-colors">Login</button>
                <p id="login-error" class="text-sm text-red-400 text-center h-4"></p>
            </form>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" class="hidden container mx-auto p-6">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-4xl text-sandstone-gold">Dashboard</h1>
            <button id="logout-button" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="bg-gray-800 p-6 rounded-lg lg:col-span-2">
                <h2 class="text-2xl text-sandstone-gold mb-4">Send Push Notification</h2>
                   <form id="push-notification-form" class="space-y-4">
                        <div>
                            <label for="push-title" class="block font-semibold mb-1">Title</label>
                            <input type="text" id="push-title" required class="w-full rounded p-2 form-input" placeholder="e.g. New Event Announced!">
                        </div>
                        <div>
                            <label for="push-body" class="block font-semibold mb-1">Message</label>
                            <textarea id="push-body" rows="2" required class="w-full rounded p-2 form-input" placeholder="e.g. Tickets for Noel Gallagher are now on sale."></textarea>
                        </div>
                        <button type="submit" class="w-full p-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg">Send Notification to All Users</button>
                   </form>
                   <p id="push-status" class="text-sm mt-3 text-green-400"></p>
                   <p class="text-xs text-gray-500 mt-2">Note: This requires Firebase Cloud Messaging setup in the main app.</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl text-sandstone-gold mb-4">Latest News</h2>
                <form id="news-form" class="space-y-4">
                    <div>
                        <label for="news-title" class="block font-semibold mb-1">Headline</label>
                        <input type="text" id="news-title" required class="w-full rounded p-2 form-input">
                    </div>
                    <div>
                        <label for="news-summary" class="block font-semibold mb-1">Summary</label>
                        <textarea id="news-summary" rows="4" required class="w-full rounded p-2 form-input"></textarea>
                    </div>
                    <button type="submit" class="w-full p-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-colors">Add News Article</button>
                </form>
                  <div id="news-list" class="mt-6 space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl text-sandstone-gold mb-4">Discounts & Offers</h2>
                <form id="offers-form" class="space-y-4">
                      <div>
                            <label for="offer-title" class="block font-semibold mb-1">Offer Title</label>
                            <input type="text" id="offer-title" required class="w-full rounded p-2 form-input">
                        </div>
                        <div>
                            <label for="offer-description" class="block font-semibold mb-1">Description</label>
                            <textarea id="offer-description" rows="3" required class="w-full rounded p-2 form-input"></textarea>
                        </div>
                         <div>
                            <label for="offer-terms" class="block font-semibold mb-1">Terms & Conditions</label>
                            <input type="text" id="offer-terms" required class="w-full rounded p-2 form-input">
                        </div>
                    <button type="submit" class="w-full p-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-colors">Add Offer</button>
                </form>
                  <div id="offers-list" class="mt-6 space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl text-sandstone-gold mb-4">Events Management</h2>
                <form id="events-form" class="space-y-4">
                    <div>
                        <label for="event-title" class="block font-semibold mb-1">Event Name</label>
                        <input type="text" id="event-title" required class="w-full rounded p-2 form-input">
                    </div>
                    <div>
                        <label for="event-date" class="block font-semibold mb-1">Event Date</label>
                        <input type="date" id="event-date" required class="w-full rounded p-2 form-input">
                    </div>
                    <div>
                        <label for="event-description" class="block font-semibold mb-1">Description</label>
                        <textarea id="event-description" rows="3" required class="w-full rounded p-2 form-input"></textarea>
                    </div>
                    <div>
                        <label for="event-tickets-url" class="block font-semibold mb-1">Ticket URL (e.g., Digitickets link)</label>
                        <input type="url" id="event-tickets-url" placeholder="https://..." class="w-full rounded p-2 form-input">
                    </div>
                    <button type="submit" class="w-full p-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition-colors">Add Event</button>
                </form>
                  <div id="events-list" class="mt-6 space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl text-sandstone-gold mb-4">My Shop Inventory</h2>
                <form id="add-stock-form" class="space-y-4">
                      <div>
                          <label for="product-name" class="block font-semibold mb-1">Product Name</label>
                          <input type="text" id="product-name" required class="w-full rounded p-2 form-input">
                      </div>
                       <div>
                          <label for="product-desc" class="block font-semibold mb-1">Description</label>
                          <textarea id="product-desc" rows="3" required class="w-full rounded p-2 form-input"></textarea>
                      </div>
                    <div>
                          <label for="product-price" class="block font-semibold mb-1">Price (Â£)</label>
                          <input type="number" step="0.01" id="product-price" required class="w-full rounded p-2 form-input">
                      </div>
                    <button type="submit" class="w-full p-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-colors">Add Product</button>
                </form>
                 <div id="stock-list-container" class="mt-6 space-y-4 max-h-60 overflow-y-auto"></div>
            </div>

        </div>
    </div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-functions.js";

    // IMPORTANT: PASTE THE FUNCTION URL YOU GET AFTER DEPLOYING HERE
    const CLOUD_FUNCTION_URL = 'PASTE_YOUR_FUNCTION_URL_HERE'; 

    const firebaseConfig = {
        apiKey: "AIzaSyBsHHRU4_ubxDgDKq9aYBAFljiOPNWyUnU",
        authDomain: "welcome-to-the-piece-hall.firebaseapp.com",
        projectId: "welcome-to-the-piece-hall",
        storageBucket: "welcome-to-the-piece-hall.appspot.com",
        messagingSenderId: "983606755725",
        appId: "1:983606755725:web:434060645154f88c2a7dc4"
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'europe-west1'); // Match your function's region

    document.addEventListener('DOMContentLoaded', () => {
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('admin-login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                listenToCollections();
            } else {
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            loginError.textContent = '';

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Login Error:", error.code, error.message);
                    switch (error.code) {
                        case 'auth/invalid-credential':
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                            loginError.textContent = "Incorrect email or password.";
                            break;
                        case 'auth/invalid-email':
                            loginError.textContent = "Please enter a valid email address.";
                            break;
                        case 'auth/network-request-failed':
                             loginError.textContent = "Network error. Check your connection or API key.";
                            break;
                        default:
                            loginError.textContent = "An unknown error occurred. Please try again.";
                            break;
                    }
                });
        });
        
        logoutButton.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout Error:", error));
        });

        const newsForm = document.getElementById('news-form');
        const offersForm = document.getElementById('offers-form');
        const stockForm = document.getElementById('add-stock-form');
        const eventsForm = document.getElementById('events-form');
        
        const newsCol = collection(db, 'news');
        const offersCol = collection(db, 'offers');
        const productsCol = collection(db, 'products');
        const eventsCol = collection(db, 'events');

        newsForm.addEventListener('submit', async e => {
            e.preventDefault();
            await addDoc(newsCol, {
                name: document.getElementById('news-title').value,
                description: document.getElementById('news-summary').value,
                createdAt: serverTimestamp()
            });
            newsForm.reset();
        });

        offersForm.addEventListener('submit', async e => {
            e.preventDefault();
            await addDoc(offersCol, {
                name: document.getElementById('offer-title').value,
                description: document.getElementById('offer-description').value,
                terms: document.getElementById('offer-terms').value,
                createdAt: serverTimestamp()
            });
            offersForm.reset();
        });

        stockForm.addEventListener('submit', async e => {
            e.preventDefault();
            await addDoc(productsCol, {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-desc').value,
                price: parseFloat(document.getElementById('product-price').value),
                createdAt: serverTimestamp()
            });
            stockForm.reset();
        });

        eventsForm.addEventListener('submit', async e => {
            e.preventDefault();
            await addDoc(eventsCol, {
                name: document.getElementById('event-title').value,
                date: document.getElementById('event-date').value,
                description: document.getElementById('event-description').value,
                ticketsUrl: document.getElementById('event-tickets-url').value,
                createdAt: serverTimestamp()
            });
            eventsForm.reset();
        });

        function listenToCollections() {
            onSnapshot(newsCol, (snapshot) => {
                const newsItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderList(document.getElementById('news-list'), newsItems, item => `<h4 class="font-semibold">${item.name}</h4><p class="text-sm text-gray-300">${item.description}</p>`);
            });
            onSnapshot(offersCol, (snapshot) => {
                const offerItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderList(document.getElementById('offers-list'), offerItems, item => `<h4 class="font-semibold">${item.name}</h4><p class="text-sm text-gray-300">${item.description}</p><p class="text-xs text-gray-400 mt-1">Terms: ${item.terms}</p>`);
            });
            onSnapshot(productsCol, (snapshot) => {
                const productItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderList(document.getElementById('stock-list-container'), productItems, product => `<h4 class="font-semibold">${product.name}</h4><p class="text-sm text-gray-300">${product.description}</p><p class="text-right font-bold mt-1">Â£${parseFloat(product.price).toFixed(2)}</p>`);
            });
            onSnapshot(eventsCol, (snapshot) => {
                const eventItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderList(document.getElementById('events-list'), eventItems, item => `<h4 class="font-semibold">${item.name}</h4><p class="text-sm text-gray-300">${item.date}</p>`);
            });
        }

        function renderList(container, items, itemHtml) {
            if (!container) return;
            container.innerHTML = items.length === 0 ? '<p class="text-gray-400">No items added yet.</p>' : '';
            items.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-gray-700 p-3 rounded';
                el.innerHTML = itemHtml(item);
                container.appendChild(el);
            });
        }
        
        const pushForm = document.getElementById('push-notification-form');
        const pushStatus = document.getElementById('push-status');

        pushForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            pushStatus.textContent = 'Sending...';
            pushStatus.classList.remove('text-red-400');
            pushStatus.classList.add('text-green-400');

            const title = document.getElementById('push-title').value;
            const body = document.getElementById('push-body').value;

            try {
                const sendPushNotification = httpsCallable(functions, 'sendPushNotification');
                const result = await sendPushNotification({ title, body });
                
                console.log('Cloud function result:', result.data);
                pushStatus.textContent = result.data.message || 'Notification sent successfully!';
                pushForm.reset();

            } catch (error) {
                console.error('Error sending push notification:', error);
                pushStatus.textContent = `Error: ${error.message}`;
                pushStatus.classList.add('text-red-400');
            } finally {
                 setTimeout(() => pushStatus.textContent = '', 4000);
            }
        });

    });
</script>
</body>
</html>

